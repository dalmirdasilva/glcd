/**
 * Glcd project
 * 
 * main.c
 * 
 * @author  Dalmir da Silva <dalmirdasilva@gmail.com>
 */
 
#include <pic18f4550.h>
#include "fuses.h"
#include "main.h"
#include "interrupt.c"


uint8_t glcd_buffer[GLCD_CHIPS][GLCD_CHIP_PAGES][GLCD_PAGE_LINES] = 
{
	{
		{
				
				
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
		},
		{
				
				
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
		},
		{
				
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
		},
		{
				
				
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
		},
		{
				
				
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
		},
		{
				
				
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
		},
		{
				
				
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
		},
		{
				
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
		},
	},
	{
		{
				
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
		},
		{
				
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
		},
		{
				
				
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
		},
		{
				
				
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
		},
		{
				
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
		},
		{
				
				
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
		},
		{
				
				
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
		},
		{
				
				
				
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
				0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
		}
	}
};

void glcd_buffered_flush() {
    uint8_t chip, page, line;
    for(chip = 0; chip < GLCD_CHIPS; chip++) {
		for(page = 0; page < GLCD_CHIP_PAGES; page++) {
			
			// Set address to 0
			glcd_command(chip, GLCD_CMD_SET_ADDRESS);
			
			// Set page to the current page
			glcd_command(chip, GLCD_CMD_SET_PAGE | page);
			
			// Loop through the addresses
			for(line = 0; line < GLCD_PAGE_LINES; line++) {
				
				// Turn pixels on or off
				glcd_write_data(chip, glcd_buffer[chip][page][line]);
			}
		}
	}
}

void main() {
    uint8_t k = 0, i, step = 0;
    uint8_t chip, page, line, d, e = 0;
    char buffer[3];
    _asm bcf _WDTCON, 0 _endasm;
    INTCONbits.GIE = 0;
    
    init_io();
    lcd_init();    
    glcd_init(GLCD_MODE_ON);
    
    init_interrupt();
    step_report_init(100);
    for(i = 0; i < 128; i++) {
        glcd_plot(i, 0, GLCD_COLOR_WHITE);
    }
    for(i = 0; i < 64; i++) {
        glcd_plot(0, i, GLCD_COLOR_WHITE);
    }
    
    glcd_buffered_flush();
    
    lcd_put_string_at("Tests:", 0, 0, 5);
    for(chip = 0; chip < GLCD_CHIPS; chip++) {
        for(page = 0; page < GLCD_CHIP_PAGES; page++) {
			for(line = 0; line < GLCD_PAGE_LINES; line++) {
                d = glcd_read_data_at(chip, page, line);
                if(d == glcd_buffer[chip][page][line]) {
                    lcd_put_string_at("Ok!!", 0, 1, 4);
                } else {
                    e++;
                    lcd_put_string_at("Fail", 0, 1, 4);
                }
                itoh(line, buffer);
                lcd_put_string_at(buffer, 7, 1, 3);
                itoh(d, buffer);
                lcd_put_string_at(buffer, 10, 1, 3);
                itoh(glcd_buffer[chip][page][line], buffer);
                lcd_put_string_at(buffer, 13, 1, 3);
                delay_ms(100);
            }
        }
    }
    delay_ms(500);
    lcd_put_string_at("Done", 6, 0, 4);
    itoh(e, buffer);
    lcd_put_string_at(buffer, 0, 1, 3);
}

void init_io() {
    TRISEbits.TRISE1 = 0;
}

/*
 * Interrupt initialization
 */
void init_interrupt() {
    
    // Prescalar reg 0
    T0CONbits.T0PS0 = 1;
    
    // Prescalar reg 1
    T0CONbits.T0PS1 = 1;
    
    // Prescalar reg 2, sets up the prescaler to 1:256
    T0CONbits.T0PS2 = 1;
    
    // Enables the prescaler
    T0CONbits.PSA = 0;
    
    // Set the clock source for internal oscillator
    T0CONbits.T0CS = 0;
    
    // Clear the interrupt flag
    INTCONbits.T0IF = 0;
    
    // Enable tmr0 interrupt
    INTCONbits.T0IE = 1;
    
    // Enable Global interrupts
    INTCONbits.GIE = 1;
}

